--Дома каторые, должны участвовать в анализе
CREATE OR REPLACE VIEW analyzed_houses AS (

	SELECT ho.bticode

		FROM house_raw AS ho
		LEFT JOIN heat_raw AS he ON ho.bticode = he.bticode


		WHERE   (he.supplier NOT LIKE '%управлени%')
			AND (he.supplier NOT LIKE '%договор%')
			AND (he.supplier NOT LIKE '%на прямых расчетах%')
			AND (he.supplier NOT LIKE '%овостройка%')
			AND (he.supplier NOT LIKE '%не начислялось%')
			AND (he.supplier NOT LIKE '%данных нет%')
			AND (he.supplier NOT LIKE '%АОГВ%')
			AND (he.supplier NOT LIKE '''газ''')
			AND (he.supplier NOT LIKE '%авт. кот.%')
			AND (he.supplier NOT LIKE '%нежилой%')
			AND (he.supplier NOT LIKE '%амостоятельный%')
			AND (he.supplier NOT LIKE '%азовый кател%')
			AND (he.supplier NOT LIKE '%снесен%')
			AND ho.category IS NULL
			
		GROUP BY ho.bticode
);

--Дома каторые, должны попасть в отчет о корректности полей
CREATE OR REPLACE VIEW houses_for_feeling_report AS (

	SELECT ho.bticode AS "Код БТИ"
		FROM analyzed_houses AS ah
		JOIN house_raw AS ho ON ah.bticode = ho.bticode
		LEFT JOIN heat_raw AS he ON ho.bticode = he.bticode
	WHERE ho.bticode IS NOT NULL
	AND (   ho.okrug IS NULL
		OR ho.raion IS NULL
		OR ho.street IS NULL
		OR ho.house IS NULL
		OR ho.house IS NULL
		OR ho.korpus = '''--'''
		OR ho.mkd_uprav_form IS NULL
		OR ho.house_type IS NULL
		OR ho.series IS NULL
		OR ho.year_built IS NULL
		OR ho.wall_type IS NULL
		OR ho.floors IS NULL
		OR ho.underfloors IS NULL
		OR ho.porches IS NULL
		OR ho.flats IS NULL
		OR ho.full_area IS NULL
		OR ho.heating_area IS NULL
		OR ho.living_area IS NULL
		OR ho.nonliving_area IS NULL
		OR ho.electricity IS NULL
		OR ho.water_hot IS NULL
		OR ho.water_cold IS NULL
		OR ho.sewerage IS NULL
		OR ho.heat_supply IS NULL
		OR ho.gas_supply IS NULL
		OR ho.gas_heaters IS NULL
		OR ho.gas_ovens IS NULL
		OR ho.electro_ovens IS NULL
		OR ho.e_devices_count IS NULL
		OR ho.hw_devices_count IS NULL
		OR ho.cw_devices_count IS NULL
		OR ho.heat_devices_count IS NULL
		OR ho.gas_devices_count IS NULL

		OR he.supplier IS NULL
		OR he.connection_type IS NULL
		OR he.system_type IS NULL
		OR he.consumer IS NULL
		OR he.resource_type IS NULL
		OR he.mes_units IS NULL
		OR he.number_of_devices IS NULL
		OR he.system_type2 IS NULL
		OR he.enter_diametr IS NULL
		OR he.enter_pressure IS NULL
		OR he.heating_grafic IS NULL
		OR he.gvs_exists IS NULL
		OR he.gvs_necessity IS NULL
		OR he.system_accounting	IS NULL
		OR he.dispatch IS NULL
		OR he.heating_connection IS NULL
		OR he.gvs_reserv IS NULL
		OR he.total_2011  IS NULL
		OR he.total_2012  IS NULL
		OR he.total_2013_jan  IS NULL
		OR he.mr_2013_jan   IS NULL
		OR he.total_2013_feb  IS NULL
		OR he.mr_2013_feb    IS NULL
		OR he.total_2013_mar  IS NULL
		OR he.mr_2013_mar    IS NULL
		OR he.total_2013_apr IS NULL
		OR he.mr_2013_apr    IS NULL
		OR he.total_2013_may  IS NULL
		OR he.mr_2013_may    IS NULL
		OR he.total_2013_jun  IS NULL
		OR he.mr_2013_jun    IS NULL
		OR he.total_2013_jul  IS NULL
		OR he.mr_2013_jul    IS NULL
		OR he.total_2013_aug  IS NULL
		OR he.mr_2013_aug    IS NULL
		OR he.total_2013_sep IS NULL
		OR he.mr_2013_sep    IS NULL
		OR he.total_2013_oct IS NULL
		OR he.mr_2013_oct    IS NULL
		OR he.total_2013_nov  IS NULL
		OR he.mr_2013_nov    IS NULL
		OR he.total_2013_dec IS NULL
		OR he.mr_2013_dec   IS NULL
		OR he.total_2013   IS NULL
		OR he.contract_load_2013 IS NULL
		OR he.temperature_grafic IS NULL
		OR he.heating_scheme 	IS NULL
		OR he.count_lift_nodes IS NULL
		OR he.heating_transit IS NULL
	) 
	GROUP BY ho.bticode
);

--Дома каторые, должны попасть в отчет о выполнении условий
CREATE OR REPLACE VIEW houses_for_uslov_report AS (

	SELECT ho.bticode AS "Код БТИ"
		FROM analyzed_houses AS ah
		JOIN house_raw AS ho ON ah.bticode = ho.bticode
		LEFT JOIN heat_raw AS he ON ho.bticode = he.bticode
	WHERE 
	GROUP BY ho.bticode
);

--Отчет о полноте данных
CREATE OR REPLACE VIEW feeling_report AS (
	SELECT 
	      (SELECT ho2.raion FROM house_raw AS ho2 
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Район",
	      (SELECT ho2.street FROM house_raw AS ho2 
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Улица",
	      (SELECT ho2.house FROM house_raw AS ho2 
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Дом",
	      (SELECT (CASE (ho2.korpus = '''--''') 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Корпус",
	      (SELECT ho2.stroenie FROM house_raw AS ho2 
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Строение",
    	      t."Код БТИ",

	      (SELECT (CASE (ho2.mkd_uprav_form IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Форма управления МКД",

	      (SELECT (CASE (ho2.house_type IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Тип дома",

	      (SELECT (CASE (ho2.series IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Серия дома",

              (SELECT (CASE (ho2.year_built IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Год постройки",

	      (SELECT (CASE (ho2.wall_type IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Тип стен",

	      (SELECT (CASE (ho2.floors IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Количество этажей",

	      (SELECT (CASE (ho2.underfloors IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Количество подземных этажей",

	      (SELECT (CASE (ho2.porches IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Количество парадных",

	      (SELECT (CASE (ho2.flats IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Количество квартир",

	      (SELECT (CASE (ho2.full_area IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Общая площадь дома",

	      (SELECT (CASE (ho2.heating_area IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Общая отапливаемой площадь",

	      (SELECT (CASE (ho2.living_area IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Площадь жилых помещений",

	      (SELECT (CASE (ho2.nonliving_area IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Площадь нежилых помещений",

	      (SELECT (CASE (ho2.electricity IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Электоэнергия",

	      (SELECT (CASE (ho2.water_cold IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "ХВС",

	      (SELECT (CASE (ho2.water_hot IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "ГВС",

	      (SELECT (CASE (ho2.sewerage IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Водоотведение",

	      (SELECT (CASE (ho2.heat_supply IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Отопление",

	      (SELECT (CASE (ho2.gas_supply IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Газоснабжение",

	      (SELECT (CASE (ho2.gas_heaters IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Оснащение газ. колонками",

	      (SELECT (CASE (ho2.gas_ovens IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Оснащение газ.плитами",

	      (SELECT (CASE (ho2.electro_ovens IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Оснащение электроплитами",

	      (SELECT (CASE (ho2.lifts_count IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Кол-во лифтов дома",

	      (SELECT (CASE (ho2.e_devices_count  IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "колич. ЭЭ",

	      (SELECT (CASE (ho2.cw_devices_count  IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "колич. ХВС",

	      (SELECT (CASE (ho2.hw_devices_count  IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "колич. ГВС",

	      (SELECT (CASE (ho2.heat_devices_count  IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "колич. ТЭ",

	      (SELECT (CASE (ho2.gas_devices_count  IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "колич. Газ",

	      (SELECT (CASE (he2.supplier IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Поставщик ресурсов",

	      (SELECT (CASE (he2.connection_type IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Тип подключения дома",

	      (SELECT (CASE (he2.consumer IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Потребитель ресурса",

	      (SELECT (CASE (he2.resource_type IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Вид ресурса",

	      (SELECT (CASE (he2.mes_units IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Ед. изм.",

	      (SELECT (CASE (he2.number_of_devices IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Кол-во приборов учета тепловой энергии",

	      (SELECT (CASE (he2.system_type2 IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Тим системы",

	      (SELECT (CASE (he2.enter_diametr IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Диаметр ввода",

	      (SELECT (CASE (he2.enter_pressure IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Давление на вводе",

	      (SELECT (CASE (he2.heating_grafic IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Температурный график тепловой сети",

	      (SELECT (CASE (he2.gvs_exists IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Наличие ГВС",

	      (SELECT (CASE (he2.gvs_necessity IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Необходимость резерва ГВС",

	      (SELECT (CASE (he2.system_accounting IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Наличие систем учета",

	      (SELECT (CASE (he2.dispatch IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Необходимость дииспетчиризации",

	      (SELECT (CASE (he2.heating_connection IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Схема присоединения к тепловой сети",

	      (SELECT (CASE (he2.gvs_reserv IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Резервирование насосов ГВС",

	      (SELECT (CASE (he2.total_2011 IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Потребление за 2011 год",

	      (SELECT (CASE (he2.total_2012 IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Потребление за 2012 год",

	      (SELECT (CASE (he2.total_2013 IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Потребление за 2013 год",

	      (SELECT (CASE (he2.total_2013_jan IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 январь",

	      (SELECT (CASE (he2.mr_2013_jan IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 январь",

	      (SELECT (CASE (he2.total_2013_feb IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 февраль",

		(SELECT (CASE (he2.mr_2013_feb IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 февраль",

	      (SELECT (CASE (he2.total_2013_mar IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 март",

	      (SELECT (CASE (he2.mr_2013_mar IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 март",

	      (SELECT (CASE (he2.total_2013_apr IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 апрель",

	      (SELECT (CASE (he2.mr_2013_apr IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 апрель",

	      (SELECT (CASE (he2.total_2013_sep IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 сентябрь",

		(SELECT (CASE (he2.mr_2013_sep IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 сентябрь",

	      (SELECT (CASE (he2.total_2013_oct IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 октябрь",

		(SELECT (CASE (he2.mr_2013_oct IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 октябрь",

	      (SELECT (CASE (he2.total_2013_nov IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 ноябрь",

		(SELECT (CASE (he2.mr_2013_nov IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 ноябрь",

	      (SELECT (CASE (he2.total_2013_dec IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Всего за 2013 декабрь",

		(SELECT (CASE (he2.mr_2013_dec IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "МР 2013 декабрь",

	      (SELECT (CASE (he2.contract_load_2013 IS NULL OR he2.contract_load_2013 > 10) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Договорная нагрузка",

	      (SELECT (CASE (he2.temperature_grafic IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Нормативный температурный график",

	      (SELECT (CASE (he2.heating_scheme IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Схема присоединения системы отопления",

	      (SELECT (CASE (he2.count_lift_nodes IS NULL)  
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END )
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Количество элеваторных узлов",

	      (SELECT (CASE (he2.heating_transit IS NULL) 
			AND ((SELECT count(he4.bticode) FROM heat_raw AS he4 WHERE he4.bticode = t."Код БТИ") = 1)
			WHEN TRUE THEN '?' END ) 
		FROM house_raw AS ho2
		LEFT JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
		WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Транзит на отопление"

	FROM houses_for_feeling_report AS t
);


copy ( 
	SELECT t.* 
	FROM feeling_report AS t
	ORDER BY t."Район", t."Улица", t."Дом", t."Корпус", t."Код БТИ"

) to '/home/vlad/reports/ac-data-qual/Отчет о полноте данных.csv'
with csv header delimiter ';' encoding 'win_1251'
;

--Дополнение к отчету о полноте данных
copy ( SELECT t."Район",
	      t."Код БТИ",
	      t."Улица",
	      t."Дом",
	      (SELECT ho2.korpus FROM house_raw AS ho2 
		WHERE ho2.raion = t."Район" 
		AND ho2.street = t."Улица" 
		AND ho2.house = t."Дом" 
		AND ho2.bticode = t."Код БТИ" LIMIT 1) AS "Корпус",
	      (SELECT ho2.stroenie FROM house_raw AS ho2 
		WHERE ho2.raion = t."Район" 
		AND ho2.street = t."Улица" 
		AND ho2.house = t."Дом" 
		AND ho2.bticode = t."Код БТИ" LIMIT 1) AS "Строение",
	      (SELECT NULL) AS "Нет информации на вкладе ТЭ",
	      (CASE ((SELECT count(ho2.bticode) FROM house_raw AS ho2 
			WHERE ho2.bticode = t."Код БТИ") = 0) AND (t."Код БТИ" IS NOT NULL) WHEN TRUE THEN 'Да' END ) AS "Нет информации на вкладе МКД",
	      (SELECT NULL) AS "Раздвоение во вкладке ТЭ",
	      (CASE ((SELECT count(ho2.street) FROM 
		
		(SELECT ho3.raion, ho3.street, ho3.house, ho3.korpus
		FROM house_raw AS ho3
		WHERE ho3.bticode = t."Код БТИ"

		) AS ho2
		GROUP BY ho2.raion, ho2.street, ho2.house, ho2.korpus LIMIT 1
		) > 1
		OR
		(SELECT count(ho2.street) FROM 
		
		(SELECT ho3.raion, ho3.street, ho3.house
		FROM house_raw AS ho3
		WHERE ho3.bticode = t."Код БТИ"

		GROUP BY ho3.raion, ho3.street, ho3.house

		) AS ho2
		) > 1) AND (t."Код БТИ" IS NOT NULL) WHEN TRUE THEN 'Да' END ) AS "Раздвоение во вкладке МКД",

	FROM
	    (SELECT ho5.raion as "Район",
		   he5.bticode AS "Код БТИ",
		   ho5.street as "Улица",
		   ho5.house as "Дом"

		   
		FROM heat_raw AS he5
		LEFT JOIN house_raw AS ho5 ON he5.bticode = ho5.bticode


		WHERE (
			(ho5.bticode IS NULL AND he5.bticode IS NOT NULL) 
			OR (
				(SELECT count(ho2.street) 
					FROM (SELECT ho3.raion, ho3.street, ho3.house, ho3.korpus
						FROM house_raw AS ho3
						WHERE ho3.bticode = he5.bticode

						) AS ho2
					GROUP BY ho2.raion, 
						 ho2.street,
						 ho2.house,
						 ho2.korpus 
						LIMIT 1

					) > 1

			)
					
			OR (
				(SELECT count(ho2.street) FROM 
		
						(SELECT ho3.raion, ho3.street, ho3.house
						FROM house_raw AS ho3
						WHERE ho3.bticode = he5.bticode

						GROUP BY ho3.raion, 
							 ho3.street, 
							 ho3.house

						) AS ho2
					) > 1
			)
				    
		     )  AND (he5.supplier NOT LIKE '%управлени%')
			AND (he5.supplier NOT LIKE '%договор%')
			AND (he5.supplier NOT LIKE '%на прямых расчетах%')
			AND (he5.supplier NOT LIKE '%овостройка%')
			AND (he5.supplier NOT LIKE '%не начислялось%')
			AND (he5.supplier NOT LIKE '%данных нет%')
			AND (he5.supplier NOT LIKE '%АОГВ%')
			AND (he5.supplier NOT LIKE '%авт. кот.%')
			AND (he5.supplier NOT LIKE '%нежилой%')
			AND (he5.supplier NOT LIKE '%амостоятельный%')
			AND (he5.supplier NOT LIKE '%азовый кател%')
			AND (he5.supplier NOT LIKE '%снесен%')
			/*AND (he5.consumer LIKE '%ДЕЗ%' 
				OR he5.consumer LIKE '%ТСЖ%'
				OR he5.consumer LIKE '%ЖСК%'
				OR he5.consumer LIKE '%УК%'
				OR he5.consumer LIKE '%МОЭК%'
				OR he5.consumer LIKE '%ГБУ%'
			)*/
			AND (
				(
					(ho5.category NOT LIKE '%едомств%')
					AND (ho5.category NOT LIKE '%бщежитие%')
					AND (ho5.category NOT LIKE '%остин%')
					AND (ho5.category NOT LIKE '%часный ж/ф%')
					AND (ho5.category NOT LIKE '%частный%')
					AND (ho5.category NOT LIKE '%договор%')
				)	
				OR (ho5.category IS NULL)
			)	
		GROUP BY "Район", "Улица", "Дом", "Код БТИ"
	    ) AS t

	ORDER BY t."Код БТИ"

) to '/home/vlad/reports/ac-data-qual/Дополнение к отчету о полноте данных.csv'
with csv header delimiter ';' encoding 'win_1251'
;


copy (
SELECT t."Номер п/п",
    t."Округ",
    t."Район",
    t."Улица",
    t."Дом",
    (SELECT ho2.korpus FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Корпус",
    (SELECT ho2.stroenie FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Строение",
    t."Код БТИ",
    (SELECT ho2.mkd_uprav_form FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Форма управления домом",
    (SELECT ho2.category FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Категория",

    (SELECT ho2.house_type FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип дома",
    (SELECT ho2.series FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Серия",
    (SELECT ho2.year_built FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Год постройки",
    (SELECT ho2.wall_type FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип стен",
    (SELECT ho2.floors FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество этажей",
    (SELECT ho2.underfloors FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Подземных этажей",
    (SELECT ho2.porches FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Подъездов",
    (SELECT ho2.flats FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Квартир",
    (SELECT ho2.full_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Общая площадь",
    (SELECT ho2.heating_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Отапливаемая площадь",
    (SELECT ho2.living_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1)  as "Площадь жилых помещений",
    (SELECT ho2.nonliving_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "площадь нежилых помещений",

    (SELECT ho2.electricity FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Электричество",
    (SELECT ho2.water_hot FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Горячая вода",
    (SELECT ho2.water_cold FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Холодная вода",
    (SELECT ho2.sewerage FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Водоотведение",
    (SELECT ho2.heat_supply FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Теплоснабжение",
    (SELECT ho2.gas_supply FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газ",
    (SELECT ho2.gas_heaters FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газовые нагреватели",
    (SELECT ho2.gas_ovens FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газовые плиты",
    (SELECT ho2.electro_ovens FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Электроплиты",
    (SELECT ho2.lifts_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количкство лифтов",

    (SELECT ho2.e_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество приборов учета электроэнергии",
    (SELECT ho2.hw_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Горячей воды",
    (SELECT ho2.cw_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Холодной воды",
    (SELECT ho2.heat_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тепловой энергии",
    (SELECT ho2.gas_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газа",
    (SELECT he2.supplier FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Поставщик", --3
    (SELECT he2.connection_type FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип подключения", --4
    (SELECT he2.consumer FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Потребитель", --5
    (SELECT he2.resource_type FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип ресурса", --6
    (SELECT he2.mes_units FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Еденицы измерения", --7
    (SELECT he2.number_of_devices FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество приборов учёта тепловой энергии", --8
    (SELECT he2.total_2011 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2011", --9
    (SELECT he2.total_2012 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2012", --10
    (SELECT he2.total_2013_jan FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 январь", -- 11
    (SELECT he2.mr_2013_jan FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 январь", --12
    (SELECT he2.total_2013_feb FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 февраль", --13
    (SELECT he2.mr_2013_feb FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 февраль",  --14
    (SELECT he2.total_2013_mar FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 март",
    (SELECT he2.mr_2013_mar FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 март", --16
    (SELECT he2.total_2013_apr FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 апрель",
    (SELECT he2.mr_2013_apr FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 апрель", --18
    (SELECT he2.total_2013_may FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 май",
    (SELECT he2.mr_2013_may FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 май", --20
    (SELECT he2.total_2013_jun FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 июнь",
    (SELECT he2.mr_2013_jun FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 июнь", --22
    (SELECT he2.total_2013_jul FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 июль",
    (SELECT he2.mr_2013_jul FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 июль", --24
    (SELECT he2.total_2013_aug FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 август",
    (SELECT he2.mr_2013_aug FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 август", --26
    (SELECT he2.total_2013_sep FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 сентябрь",
    (SELECT he2.mr_2013_sep FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 сентябрь", --28
    (SELECT he2.total_2013_oct FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 октябрь",
    (SELECT he2.mr_2013_oct FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 октябрь", --30
    (SELECT he2.total_2013_nov FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 ноябрь",
    (SELECT he2.mr_2013_nov FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 ноябрь", --32
    (SELECT he2.total_2013_dec FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 декабрь",
    (SELECT he2.mr_2013_dec FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 декабрь", --34
    (SELECT he2.total_2013 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "всего за 2013", --35
    (SELECT he2.contract_load_2013 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Договорная нагрузка (годовая за 2013г.)", --37
    (SELECT he2.temperature_grafic FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Нормативный температурный график", --38
    (SELECT he2.heating_scheme FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Схема присоединения системы отопления (зависимая/независимая)", --39 
    (SELECT he2.count_lift_nodes FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество элеваторных узлов (при их наличии)", --40
    (SELECT he2.heating_transit FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1)  as "Наличие транзита на отопление (разгружен/не разгружен)", --41 
    (SELECT p_2011.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_2011 AS p_2011 ON ho2.bticode = p_2011.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Удельное потребление за 2011",
    (SELECT p_2012.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_2012 AS p_2012 ON ho2.bticode = p_2012.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Удельное потребление за 2012",
    (SELECT p_2013.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_2013 AS p_2013 ON ho2.bticode = p_2013.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Удельное потребление за 2013",
    (SELECT p_3y.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_3y AS p_3y ON ho2.bticode = p_3y.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Среднее удельное потребление по трём годам"
    
from (SELECT ho.id_in_file as "Номер п/п",
	    ho.okrug as "Округ",
	    ho.raion as "Район",
	    ho.street as "Улица",
	    ho.house as "Дом",
	    ho.bticode as "Код БТИ"

	   
	FROM house_raw AS ho
	LEFT JOIN heat_raw AS he ON ho.bticode = he.bticode

	GROUP BY "Округ", "Район", "Улица", "Дом", "Код БТИ", "Номер п/п"
    ) AS t

ORDER BY t."Код БТИ"

) to '/home/vlad/reports/ac-data-qual/Полный отчет (в форме Внуково) только по коду БТИ.csv'
with csv header delimiter ';' encoding 'win_1251'
;

--Объединение двух вкладок только по коду БТИ
copy (
SELECT t."Номер п/п",
    t."Округ",
    t."Район",
    t."Улица",
    t."Дом",
    (SELECT ho2.korpus FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Корпус",
    (SELECT ho2.stroenie FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Строение",
    t."Код БТИ",
    (SELECT ho2.mkd_uprav_form FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Форма управления домом",
    (SELECT ho2.category FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Категория",

    (SELECT ho2.house_type FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип дома",
    (SELECT ho2.series FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Серия",
    (SELECT ho2.year_built FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Год постройки",
    (SELECT ho2.wall_type FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип стен",
    (SELECT ho2.floors FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество этажей",
    (SELECT ho2.underfloors FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Подземных этажей",
    (SELECT ho2.porches FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Подъездов",
    (SELECT ho2.flats FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Квартир",
    (SELECT ho2.full_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Общая площадь",
    (SELECT ho2.heating_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Отапливаемая площадь",
    (SELECT ho2.living_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1)  as "Площадь жилых помещений",
    (SELECT ho2.nonliving_area FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "площадь нежилых помещений",

    (SELECT ho2.electricity FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Электричество",
    (SELECT ho2.water_hot FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Горячая вода",
    (SELECT ho2.water_cold FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Холодная вода",
    (SELECT ho2.sewerage FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Водоотведение",
    (SELECT ho2.heat_supply FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Теплоснабжение",
    (SELECT ho2.gas_supply FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газ",
    (SELECT ho2.gas_heaters FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газовые нагреватели",
    (SELECT ho2.gas_ovens FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газовые плиты",
    (SELECT ho2.electro_ovens FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Электроплиты",
    (SELECT ho2.lifts_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количкство лифтов",

    (SELECT ho2.e_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество приборов учета электроэнергии",
    (SELECT ho2.hw_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Горячей воды",
    (SELECT ho2.cw_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Холодной воды",
    (SELECT ho2.heat_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тепловой энергии",
    (SELECT ho2.gas_devices_count FROM house_raw AS ho2 
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Газа",
    (SELECT he2.supplier FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Поставщик", --3
    (SELECT he2.connection_type FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип подключения", --4
    (SELECT he2.system_type FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Вид схемы теплоснабжения", --5
    (SELECT he2.consumer FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Потребитель", --6
    (SELECT he2.resource_type FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Тип ресурса", --7
    (SELECT he2.mes_units FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Еденицы измерения", --8
    (SELECT he2.number_of_devices FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество приборов учёта тепловой энергии", --8
    (SELECT he2.total_2011 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2011", --9
    (SELECT he2.total_2012 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2012", --10
    (SELECT he2.total_2013_jan FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 январь", -- 11
    (SELECT he2.mr_2013_jan FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 январь", --12
    (SELECT he2.total_2013_feb FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 февраль", --13
    (SELECT he2.mr_2013_feb FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 февраль",  --14
    (SELECT he2.total_2013_mar FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 март",
    (SELECT he2.mr_2013_mar FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 март", --16
    (SELECT he2.total_2013_apr FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 апрель",
    (SELECT he2.mr_2013_apr FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 апрель", --18
    (SELECT he2.total_2013_may FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 май",
    (SELECT he2.mr_2013_may FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 май", --20
    (SELECT he2.total_2013_jun FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 июнь",
    (SELECT he2.mr_2013_jun FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 июнь", --22
    (SELECT he2.total_2013_jul FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 июль",
    (SELECT he2.mr_2013_jul FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 июль", --24
    (SELECT he2.total_2013_aug FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 август",
    (SELECT he2.mr_2013_aug FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 август", --26
    (SELECT he2.total_2013_sep FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 сентябрь",
    (SELECT he2.mr_2013_sep FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 сентябрь", --28
    (SELECT he2.total_2013_oct FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 октябрь",
    (SELECT he2.mr_2013_oct FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 октябрь", --30
    (SELECT he2.total_2013_nov FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 ноябрь",
    (SELECT he2.mr_2013_nov FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 ноябрь", --32
    (SELECT he2.total_2013_dec FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Всего за 2013 декабрь",
    (SELECT he2.mr_2013_dec FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Метод расчёта 2013 декабрь", --34
    (SELECT he2.total_2013 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "всего за 2013", --35
    (SELECT he2.contract_load_2013 FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Договорная нагрузка (годовая за 2013г.)", --37
    (SELECT he2.temperature_grafic FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Нормативный температурный график", --38
    (SELECT he2.heating_scheme FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Схема присоединения системы отопления (зависимая/независимая)", --39 
    (SELECT he2.count_lift_nodes FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) as "Количество элеваторных узлов (при их наличии)", --40
    (SELECT he2.heating_transit FROM house_raw AS ho2 
	JOIN heat_raw AS he2 ON ho2.bticode = he2.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1)  as "Наличие транзита на отопление (разгружен/не разгружен)", --41 
    (SELECT p_2011.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_2011 AS p_2011 ON ho2.bticode = p_2011.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Удельное потребление за 2011",
    (SELECT p_2012.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_2012 AS p_2012 ON ho2.bticode = p_2012.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Удельное потребление за 2012",
    (SELECT p_2013.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_2013 AS p_2013 ON ho2.bticode = p_2013.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Удельное потребление за 2013",
    (SELECT p_3y.udel_poterb FROM house_raw AS ho2 
	JOIN udel_poterb_3y AS p_3y ON ho2.bticode = p_3y.bticode
	WHERE ho2.bticode = t."Код БТИ" LIMIT 1) AS "Среднее удельное потребление по трём годам"
    
from (SELECT ho.id_in_file as "Номер п/п",
	    ho.okrug as "Округ",
	    ho.raion as "Район",
	    ho.street as "Улица",
	    ho.house as "Дом",
	    ho.bticode as "Код БТИ"

	   
	FROM house_raw AS ho
	JOIN heat_raw AS he ON ho.bticode = he.bticode

	GROUP BY "Округ", "Район", "Улица", "Дом", "Код БТИ", "Номер п/п"
    ) AS t

ORDER BY t."Код БТИ"

) to '/home/vlad/reports/ac-data-qual/Объединение двух вкладок только по коду БТИ.csv'
with csv header delimiter ';' encoding 'win_1251'
;




